@page "/item/edit/{Id:guid?}"
@rendermode InteractiveAuto
@using Microsoft.AspNetCore.SignalR.Client
@using SmartWarehouse.Shared.Models
@using SmartWarehouse.Shared.Services

@inject IBarcodeScanner Scanner
@inject NavigationManager Nav

<h3>ðŸ“¦ Warehouse Item Editor</h3>
@if (CurrentItem is null)
{
    <div class="d-flex align-items-center gap-2">
        <div class="spinner-border text-primary" role="status"></div>
        <span>Loading...</span>
    </div>
}
else
{
    <EditForm Model="@CurrentItem" OnValidSubmit="HandleSave">
        <DataAnnotationsValidator/>
        <ValidationSummary/>

        <div class="mb-3">
            <label>Item Name</label>
            <InputText @bind-Value="CurrentItem.Name" class="form-control"/>
        </div>

        <div class="mb-3">
            <label>Quantity</label>
            <InputNumber @bind-Value="CurrentItem.Quantity" class="form-control"/>
        </div>

        <div class="mb-3">
            <label>SKU</label>
            <InputText @bind-Value="CurrentItem.Sku" class="form-control"/>
        </div>

        <button type="button" class="btn-secondary btn" @onclick="ScanSkuAsync">Scan Sku</button>

        <button type="submit" class="btn btn-primary">Save Item</button>
    </EditForm>
}

@if (_lastSavedMessage is not null)
{
    <div class="alert alert-success mt-3">@_lastSavedMessage</div>
}

@code {
    [Parameter] public Guid? Id { get; set; }

    // .NET 10 Feature: [PersistentState]
    // This automatically saves/restores this object during the 
    // "Server -> Client" handoff. No more double-fetching!
    [PersistentState] public InventoryItem? CurrentItem { get; set; } = new();

    private string? _lastSavedMessage;
    private HubConnection? _hubConnection;
    private bool _isInitialized;
    
    protected override async Task OnInitializedAsync()
    {
        CurrentItem ??= new InventoryItem();
        
        if (CurrentItem.Id != Guid.Empty && !string.IsNullOrEmpty(CurrentItem.Name))
        {
            return;
        }

        if (Id.HasValue)
        {
            await Task.Delay(500); // Fake DB latency
            CurrentItem = new InventoryItem
            {
                Id = Id.Value,
                Name = "Industrial Drill",
                Quantity = 50,
                Sku = "DRILL-2025"
            };
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!firstRender || _isInitialized)
        {
            return;
        }

        _isInitialized = true;
        await InitializeSignalRAsync();
    }

    private async Task InitializeSignalRAsync()
    {
        if (_hubConnection is not null && 
            (_hubConnection.State == HubConnectionState.Connected || 
             _hubConnection.State == HubConnectionState.Connecting))
        {
            return;
        }

        try 
        {
            var hubUrl = HubUrlHelper.GetHubUrl(Nav, "/inventoryhub");
            
            _hubConnection = new HubConnectionBuilder()
                .WithUrl(hubUrl)
                .Build();

            _hubConnection.On<Guid, int>("ReceiveItemUpdate", (itemId, newQty) =>
            {
                // Check if the update is for the item we are currently looking at
                // if (CurrentItem is null || CurrentItem.Id != itemId) return;
                CurrentItem.Quantity = newQty;
                    
                // IMPORTANT: Tell Blazor the UI changed!
                InvokeAsync(StateHasChanged);
            });

            await _hubConnection.StartAsync();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"SignalR Error: {ex.Message}");
        }
    }

    private async Task HandleSave()
    {
        _lastSavedMessage = $"Saved {CurrentItem?.Name} (Qty: {CurrentItem?.Quantity}) at {DateTime.Now.ToShortTimeString()}";
        
        if (_hubConnection is not null && _hubConnection.State == HubConnectionState.Connected)
        {
            await _hubConnection.SendAsync("NotifyItemUpdated", CurrentItem?.Id, CurrentItem?.Quantity);
        }
    }

    private async Task ScanSkuAsync()
    {
        var code = await Scanner.ScanAsync();
        if (!string.IsNullOrEmpty(code))
        {
            CurrentItem!.Sku = code;
        }
    }

    public async ValueTask DisposeAsync()
    {
        if (_hubConnection is not null)
        {
            if (_hubConnection.State == HubConnectionState.Connected)
            {
                await _hubConnection.StopAsync();
            }
            await _hubConnection.DisposeAsync();
        }
    }
}